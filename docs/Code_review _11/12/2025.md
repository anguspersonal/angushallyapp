# Code Review – 11/12/2025

Each finding is listed separately with its name, detail, justification, priority, status, date created, and last updated.

### 1. Login/Registration queries ignore db.query return shape
- **Name:** Login/Registration queries ignore db.query return shape
- **Detail:** `server/db.js` documents that `query` returns the rows array, but the email/password registration and login handlers in `server/routes/authRoute.js` still reference `result.rows`. Because `result` is already an array, those properties are `undefined`, so both handlers throw before sending a response, breaking local auth.
- **Justification:** Ensures authentication endpoints execute successfully and handle missing users instead of crashing on undefined access.
- **Priority:** High
- **Status:** Open
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 2. Google auth transaction does not use a single client
- **Name:** Google auth transaction does not use a single client
- **Detail:** The Google OAuth flow issues `BEGIN`/`ROLLBACK`/`COMMIT` via `db.query`, which grabs a fresh pool client per call. The transaction commands therefore run on different connections, providing no atomicity and risking partial writes if later queries fail.
- **Justification:** Critical for data integrity when creating or updating users during Google sign-in; fixes require using one client for the entire transaction.
- **Priority:** High
- **Status:** Open
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 3. PII logging in Google auth
- **Name:** PII logging in Google auth
- **Detail:** The Google auth handler logs the full authentication payload (Google subject, email, first/last name) to stdout when processing tokens.
- **Justification:** Emitting raw identity data to application logs increases exposure risk and complicates compliance; these logs are not redacted or gated by environment.
- **Priority:** Medium
- **Status:** Open
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 4. Protect Strava activity API
- **Name:** Protect Strava activity API
- **Detail:** `GET /api/strava` exposes the full `habit.strava_activities` table without authentication or user scoping—the route simply fetches all activities and returns them to any caller.
- **Justification:** Strava activity data is user-specific; returning every row without verifying the requester risks privacy breaches and data scraping. The route should require authentication and filter by the authenticated user’s Strava profile.
- **Priority:** High
- **Status:** Open
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 5. Gate the OpenAI analyse-text endpoint
- **Name:** Gate the OpenAI analyse-text endpoint
- **Detail:** `/api/analyseText/analyze` allows anonymous POSTs that forward arbitrary text to the OpenAI client; the only checks are non-empty text and a global rate limit.
- **Justification:** Without authentication, size limits, or abuse monitoring, this endpoint can be spammed to incur OpenAI costs or prompt-injection payloads. It should require auth, enforce payload bounds, and log usage with correlation IDs.
- **Priority:** High
- **Status:** Open
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 6. Harden contact form reCAPTCHA handling
- **Name:** Harden contact form reCAPTCHA handling
- **Detail:** reCAPTCHA verification errors are logged to `console.error` and treated as user failures (`400`), and the remote IP is not sent to Google for verification.
- **Justification:** Operational outages (network/Google) will silently surface as user errors, making issues hard to diagnose and blocking legitimate submissions. Use the structured logger with correlation IDs, differentiate server errors from invalid tokens, and include `remoteip` to reduce false positives.
- **Priority:** Medium
- **Status:** Open
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 7. Password validator crashes on missing input
- **Name:** Password validator crashes on missing input
- **Detail:** `validatePassword` in `src/utils/validators.js` dereferences `password.length` without checking for null/undefined. When the password is missing, the auth route will throw a 500 instead of returning validation errors.
- **Justification:** Improves request robustness and aligns with the explicit validation path that should return 400-level errors for bad input.
- **Priority:** Medium
- **Status:** Open
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 8. Stub auth route lacks persistence and security controls
- **Name:** Stub auth route lacks persistence and security controls
- **Detail:** The legacy frontend auth stub has been removed in favor of the fully featured `server/routes/authRoute.js`, and `/api/auth` is now protected by a dedicated rate limiter alongside hashed-password persistence.
- **Justification:** Prevents exposure of misleading or insecure auth endpoints and ensures the production auth flow remains the only mounted implementation.
- **Priority:** Medium
- **Status:** Resolved
- **Date Created:** 2025-11-12
- **Last Updated:** 2025-11-12

### 9. Contact owner notifications drop message body
- **Name:** Contact owner notifications drop message body
- **Detail:** `sendInquiryToOwner` expects a subject and message, but `contact.js` calls it with three arguments (`name`, `email`, `message`), causing the message body to be `undefined` and the email subject to mirror the user message instead of a labeled subject.
- **Justification:** Missing message content reduces traceability and forces the owner to retrieve the submission content from other emails, while misleading subjects make filtering harder.
- **Priority:** High
- **Status:** Open
- **Date Created:** 2025-02-03
- **Last Updated:** 2025-02-03

### 10. Acknowledgment emails go to the site owner instead of the submitter
- **Name:** Acknowledgment emails go to the site owner instead of the submitter
- **Detail:** `sendAcknowledgmentToUser` calls `sendEmail` without a `to` value, so the default recipient (`config.email.recipient`) receives the acknowledgment rather than the user who filled the contact form. The route passes the user's email, but it is never used as the destination.
- **Justification:** Users do not receive confirmation, undermining trust and increasing duplicate submissions, while the owner receives redundant emails.
- **Priority:** High
- **Status:** Open
- **Date Created:** 2025-02-03
- **Last Updated:** 2025-02-03

### 11. Email sender uses per-request Gmail password authentication without pooling
- **Name:** Email sender uses per-request Gmail password authentication without pooling
- **Detail:** Each email send recreates a Gmail transporter with username/password credentials and no connection pooling or rate safeguards, introducing extra latency and exposing risk if the password is an app password instead of OAuth.
- **Justification:** Recreating transports increases delivery latency under load, and password-based Gmail auth is deprecated and more fragile than OAuth with reusable connections; pooling and modern auth would improve reliability.
- **Priority:** Medium
- **Status:** Open
- **Date Created:** 2025-02-03
- **Last Updated:** 2025-02-03
